1  数据
1.1 数据集种类
类别	用处	处理方式	观察指标	例子
训练集	训练模型	可以做欠采样,过采样,数据增强	模型loss	1.1的日活用户,正样本1m,负样本100m,采样后正样本1m,负样本2m
验证集	选超参数	简单采样,简单增强	模型loss,业务指标	1.3全量用户,正样本1m,负样本100m,采样后(正样本1k,负样本100k)
测试集	模型推理	简单采样,简单增强	业务指标	1.5全量用户,正样本1m,负样本100m
1.2 数据集偏差和过拟合

过拟合:

发现过拟合: 测试精度远小于训练精度

过拟合通常不是什么大问题:

模型架构有大量正则
一定量的过拟合测试精度不会很低
解决过拟合很容易(通常先训到过拟合)




数据集偏差:




发现偏差:测试精度小于训练精度(加入正则并不会改善)

本质原因:训练集和测试集都是总体分布的一部分




dataset bias在每个项目都有踪影:

推荐/流失/hack的数据时间窗口
选择了活动日期
region不同
CTR→CVR
语言域
图片选择




有的偏差是可以接受的:

测试分布是训练分布的一部分(全量玩家训练,预测大R)
训练分布是测试分布的一部分,但是测试分布的其余部分不重要(有购买记录的玩家训练,预测全量)




解决偏差:

检验时间窗口,
选择多dt
dt间隔挑选
分region建模
大数据集预训练 + 私有域数据集微调




1.3 推荐场景的数据流
精排(gbt,essm)

train:

收集历史曝光购买数据  →  负样本采样(可选)  → 模型训练

test:

user召回,item召回  → 构造笛卡尔积并预测




召回(多路)
als
word2vec
price
popularity
历史点击/历史购买/相似品牌/相似风格/竞品/优惠

合并多路召回喂给精排

召回(双塔)

train:

收集历史曝光购买数据  →  负样本采样(可选)  → 模型训练

test:

遍历item得到embedding,构造索引,遍历user计算embedding查询top k










2 模型
2.1 双塔
what:




双塔可以是不同网络,也可以相同(孪生网络),塔的作用:特征提取

头部向量ab的计算可以选择 余弦,内积,欧式距离等等




why:
减少计算(两个方面减少,重复计算和向量查询)
两个塔可以分开独立运算




where:
推荐召回
一些场景的精排
预训练user /item 的embedding
求相似/匹配的场景




how:

训练:

场景	双塔	loss
推荐	user/item	BCE
相似计算(文本,图片,商品,用户)	共享权重	contrastive

如果相似计算选择内积或者距离,最后一层要除自身的范数




测试指标:

场景	观察指标
推荐系统 – 召回	top-n recall
推荐系统 – 精排	top-n agpu
相似度查询	依赖业务 




测试方式:

场景	计算方式
数据量中等或者较小	a塔和b塔分别获取embedding后做笛卡尔积
数据量中等或者较小,相似度用内积/余弦	a塔和b塔分别获取embedding矩阵A和B,直接计算ABT
数据量很大	b塔计算embedding后构建索引,对每个a塔向量,用k近邻查询










3 模型训练
3.1 预训练+微调
what:




why:
获得目标数据集没有的知识,减少目标数据集的数据需求
加速收敛
充当初始化权重
提升测试精度




where:
CTR CVR
embedding(item/user/word)
nlp:bert
cv:resnet




how:
训练方式	适用场景
主体权重保持不变,头重新训	新数据集-小
主体较小的学习率,头较大学习率	新数据集-中
直接重训	新数据集-大
在新知识集合继续预训练之后再训特定任务	存在新的知识集合,且新数据集-小







4 模型结果 
4.1 概率校准
用户	是否购买
男*10	1
男*2000	0
女*10	1
女*1000	0

正负比 2:300




x=男

model(x) = 1/201

x=女

model(x) = 1/101




欠采样   (负样本采样比例1:100)
原始用户数量	采样后用户数量	是否购买
男*10	男*10	1
男*2000	男*20	0
女*10	女*10	1
女*1000	女*10	0

正负比 2:3




x=男

model(x) = 1/3

x=女

model(x) = 1/2

对采样后的模型分重新调整:

采样比例:w

采样后模型分:scores

prob = (scores * w) / (1 + scores * w - scores)







4.2 结果分析
4.2.1 内部观察结果
模型	指标	

2分类	auc	衡量模型能力,且和阈值无关,用在训练集和验证集,和loss一样可以观察模型的拟合情况
多分类	展开的 auc	同上
推荐/流失	分组的 auc	同上,可以观察不同组的拟合情况
分类	precision/recall/f score	和阈值有关,可以衡量模型实际应用的能力,帮助选取阈值,比较通用,用在验证集和测试集
-	业务指标	用于验证集和测试集




4.2.2 外部观察结果




pr曲线:

观察模型整体表现
帮助选择阈值




模型分桶:

可以很直观的观察模型不同分段用户分布和真实表现
帮助选择阈值




ab测试





























